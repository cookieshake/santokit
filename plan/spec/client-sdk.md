# Client SDK 자동 생성 — Spec (요약)

목표:
- 릴리즈 메타데이터(스키마 IR)로부터 타입 안전한 클라이언트 SDK를 자동 생성한다.
- 개발자가 수동으로 API 타입을 정의하는 반복 작업을 제거한다.

---

## 1) CLI 명령어

```
stk gen client --lang typescript --output <path> [--env <env>]
```

| 플래그 | 설명 | 기본값 |
|--------|------|--------|
| `--lang` | 대상 언어 (`typescript`만 지원, v0) | 필수 |
| `--output` | 출력 디렉토리/파일 경로 | 필수 |
| `--env` | 대상 환경 (해당 환경의 현재 릴리즈 사용) | context의 env |

### 동작

1. Hub에서 대상 env의 현재 릴리즈를 가져온다.
2. 릴리즈의 스키마 IR에서 테이블/컬럼/타입 정보를 추출한다.
3. 대상 언어의 템플릿으로 코드를 생성한다.

구분:
- SDK 생성(`stk gen client`)은 Hub(Control Plane)의 릴리즈 메타데이터를 사용한다.
- 생성된 SDK의 런타임 호출은 Bridge(Data Plane) (`POST /call`)를 대상으로 한다.

---

## 1.1) 생성된 API 구조 (repo 구조 반영)

원칙:
- 생성된 클라이언트의 모듈/네임스페이스 구조는 **프로젝트 레포의 구조와 Santokit 호출 경로**를 최대한 반영한다.


매핑:
- `schema/*.yaml` → `client.db.<table>`

출력(TypeScript v0):
- `<output>` 단일 파일(TypeScript)만 생성한다.

이름 규칙:
- 파일/경로/테이블 이름은 원본을 보존하되, 프로퍼티 접근은 언어 관용에 맞게 변환한다.
  - 예: `upload_sign` → `uploadSign`, `order_items` → `orderItems`
  - 변환 충돌이 발생하면(동일한 결과 이름), 원본 키 문자열 접근(예: `client.db["order_items"]`)을 제공한다.

경로 매핑 규칙:
- 테이블:
  - table name은 `schema/*.yaml`의 `tables.<name>`을 사용한다(파일명은 의미가 없다).

예시:
- `schema/users.yaml`에 `tables.users`가 있으면: `client.db.users.select(...)`

---

## 1.2) API Shape (TypeScript MVP 결정)

원칙:
- SDK의 호출 형태는 Santokit `/call`의 `path` 구조를 그대로 반영한다.
- query builder를 과도하게 만들지 않고, `plan/spec/crud.md`의 params 형태를 타입으로 제공한다.

CRUD API:
- `client.db.<table>.select(params)`
- `client.db.<table>.insert(data)`
- `client.db.<table>.update(where, data)`
- `client.db.<table>.delete(where)`

결정:
- 테이블은 "객체 + 메서드" 형태로 노출한다(구현이 class이든 함수형이든 무관).
- MVP에서는 체이닝 기반 query builder는 제공하지 않는다.

## 2) 타입 매핑

| 스키마 타입 | TypeScript |
|------------|------------|
| `string` | `string` |
| `int` | `number` |
| `bigint` | `string` |
| `float` | `number` |
| `decimal` | `string` |
| `boolean` | `boolean` |
| `json` | `unknown` |
| `timestamp` | `string` (RFC3339) |
| `bytes` | `string` (base64) |
| `file` | `string` (storage key) |
| `array<T>` | `T[]` |

Nullable: `nullable: true`이면 `T | null`로 매핑.

### 2.1 직렬화 규칙 (JSON)

Bridge `/call`의 JSON은 아래 표준을 따른다.

- `timestamp`: RFC3339 문자열로 전송한다(런타임 파싱은 사용자 선택).
- `bigint`: JSON wire format은 문자열로 전송/수신한다(정밀도 보존).
- `decimal`: 문자열로 전송한다(정밀도 유지를 위해 number 금지).
- `bytes`: RFC4648 base64 문자열로 전송한다(줄바꿈 없음). TypeScript SDK는 필요 시 디코드한다.
- `file`: storage key 문자열로 전송한다(직접 다운로드 URL이 아님).
  - 다운로드/업로드는 Storage API(서명 발급)를 통해 수행한다.

---

## 3) 생성 코드 구조 (TypeScript 예시)

```typescript
// generated by stk gen client (v0)
// 단일 파일로 생성되며, `POST /call` 래퍼 + 최소 타입을 제공한다.

export interface User {
  id: string;
  email: string;
  name: string;
  created_at: string;
}

export interface InsertUser {
  email: string;
  name: string;
}

export class UsersTable {
  constructor(private client: SantokitClient) {}

  async select(params?: {
    where?: { id?: string; email?: string; /* ... */ };
    orderBy?: Record<string, 'asc' | 'desc'>; // key는 column name
    limit?: number;
    offset?: number;
    expand?: string[];
  }): Promise<User[]> { /* ... */ }

  async insert(data: InsertUser | InsertUser[]): Promise<User[]> { /* ... */ }
  async update(where: { id: string }, data: Partial<InsertUser>): Promise<User[]> { /* ... */ }
  async delete(where: { id: string }): Promise<{ affected: number }> { /* ... */ }
}

// Client entrypoint
export class MyAppClient {
  db: {
    users: UsersTable;
  };

  constructor(config: { bridgeUrl: string; apiKey?: string; accessToken?: string }) {
    /* ... */
  }
}
```

---

## 4) 에러 타입

```typescript
export interface SantokitError {
  code: string;        // 'BAD_REQUEST', 'UNAUTHORIZED', 'FORBIDDEN', 'NOT_FOUND', 'INTERNAL_ERROR'
  message: string;
  requestId: string;
}
```

- SDK는 HTTP 상태 코드에 따라 `SantokitError`를 throw/return한다.
- TypeScript에서는 예외(throw)로 표현한다.

### 4.1 Permissions 반영 범위(결정)

- SDK는 permissions(roles/columns/CEL)을 **클라이언트에서 재현하려고 하지 않는다**.
- 허용/거부는 Bridge 런타임이 최종 판단한다.
- 따라서 SDK는 "컬럼 숨김" 같은 정적 제약을 강제하지 않고, 실패 시 `403 FORBIDDEN`을 반환/throw한다.

---

## 5) 인증 통합

```typescript
const client = new MyAppClient({
  bridgeUrl: 'https://bridge.example.com',
  apiKey: 'stk_key_...',          // 서버/CI용
  // 또는
  accessToken: 'stk_at_...',     // End User용
});
```

- API key와 access token 중 하나를 설정한다.
- access token 만료/갱신은 MVP에서 자동화하지 않는다.

---

## 6) Compatibility / 버저닝(결정)

- 생성된 SDK는 "생성 시점의 릴리즈"에 맞춰 타입/경로를 고정한다.
- 생성 결과물에는 아래 메타데이터를 포함한다:
  - `generatedBy`: `stk gen client` 버전
  - `releaseId`: 생성에 사용한 releaseId
- 런타임에서 서버 releaseId와의 자동 불일치 감지는 MVP에서 제공하지 않는다.
  - 대신, 배포/스키마 변경 후에는 해당 env 기준으로 SDK를 재생성하는 것을 기본 운영 방식으로 둔다.

권장:
- 생성된 SDK 파일 상단에 `releaseId`를 주석/상수로 남겨 디버깅 시 추적 가능하게 한다.

---

미결정 항목은 `plan/notes/open-questions.md`에서 관리한다.
