# Santokit Rebuild Spec v1 (Hub-less)

이 문서는 재창조 Santokit의 “현행 스펙(단일 진실 원천)”이다.

핵심 결정:
- Hub 없음 (manifest registry / vault / projects / auth API 모두 제거)
- BYO DB: Postgres + libsql(+Cloudflare D1) 지원
- 스키마 소스: `schema/*.yaml` (YAML 고정) + 내부 IR → 엔진별 plan/apply
- 배포: `stk deploy <target>`가 오케스트레이션
  - `stk deploy image` (Bridge 컨테이너 이미지에 manifest/bundle bake-in)
  - `stk deploy cfworker` (Cloudflare Workers 배포; wrangler 직접 호출 + 사용자 확인)
- secrets: 배포 타겟의 secret manager가 Source of Truth (이미지/번들에 포함 금지)
- 타입 생성: `stk sync`는 로컬의 manifest를 기준으로 타입 정의를 생성

---

## 1) Components

### 1.1 CLI (`stk`)
역할:
- 프로젝트 초기화/검증/번들링/배포/타입 생성의 단일 진입점
- DB 스키마 plan/apply를 로컬/CI에서 수행 (Hub-less)

### 1.2 Bridge (Runtime)
역할:
- `/call` API 제공
- manifest/bundle을 로컬 경로에서 로드(bake-in)
- DB/스토리지/캐시/권한(최소)을 실행 환경에 맞게 연결

멀티 프로젝트:
- v1에서는 “한 Bridge = 한 프로젝트”를 기본으로 한다. (프로젝트별 배포)
- 배경/대안: `plan/spec/multi-project.md`

지원 런타임(필수):
- Node/Docker
- Cloudflare Workers

### 1.3 Client SDK
역할:
- 타입 안전 호출(`client.users.get(...)` 형태)
- `/call` 호출 어댑터 + auth token 전달(선택)

---

## 2) Repository & Project Layout

### 2.1 User Project Layout (created by `stk init`)
```
project-root/
├── schema/
│   └── main.yaml
├── config/
│   └── santokit.yaml
├── logic/
│   └── users/get.sql
├── .stk/
│   ├── santokit-env.d.ts
│   └── manifest.json
└── stk.config.json
```

Notes:
- `.stk/manifest.json`은 `stk bundle`이 생성하는 로컬 아티팩트다.
- `config/santokit.yaml`은 deploy/runtime 설정(타겟, DB alias, 권한 설정 경로 등)을 담는다.

### 2.2 Logic File Rules
- 단일 파일 + frontmatter(메타) + body(SQL/JS)
- Twin File 모드 지원:
  - `logic/foo.yaml` (메타)
  - `logic/foo.sql` 또는 `logic/foo.js` (실행)

Visibility:
- `_` prefix 로직은 private (SDK 타입에서 제외 + 외부 호출 거부)

---

## 3) Schema (YAML, BYO DB)

소스:
- `schema/main.yaml` (MVP: 단일 파일)

스키마 엔진:
- `database.engine = "postgres" | "sqlite"`
  - libsql/D1은 `sqlite` 엔진으로 취급

타입:
- logical type 집합으로 고정(자세한 내용은 `plan/spec/schema-yaml.md`)
- `timestamp`는 모든 엔진에서 `integer (epoch milliseconds, UTC)`로 고정
- ID 생성 default는 `gen_uuidv7` / `gen_typeid`를 허용하되, MVP에서는 **app-generated**로만 동작한다.
- `gen_typeid`의 prefix는 **테이블명 기반 자동**으로 생성한다.

CLI 명령:
- `stk schema validate` (로컬 파싱/규칙 검증 + 엔진별 컴파일 가능성 확인)
- `stk schema plan` (현재 DB introspection vs 목표 스키마 diff)
- `stk schema apply` (안전한 subset 적용; 파괴적 변경은 기본 차단)

---

## 4) Secrets (No Hub)

원칙:
- secret 값은 Git/manifest/bundle/image에 절대 포함하지 않는다.
- secret은 런타임 환경변수로 주입된다.

런타임별:
- Node: `process.env.NAME`
- Cloudflare: `env.NAME`

CLI:
- `stk secrets template` (로컬 `.env.local` 템플릿 생성)
- `stk secrets validate` (필수 secret 누락 체크)

Cloudflare Workers:
- `stk deploy cfworker`는 wrangler를 직접 호출한다.
- 배포/secret 변경은 반드시 사용자 확인(prompt)을 받는다.

---

## 5) Deploy (Targets)

### 5.1 Common Build Artifact
- `stk bundle` → `.stk/manifest.json` + bundle (tgz or directory)

manifest는 최소한 다음을 포함한다:
- logic index: `{ path -> handler }`
- logic metadata: visibility/auth/cache/params schema(versioned)
- schema version/signature (옵션)

### 5.2 `stk deploy image`
의미:
- Bridge(Node) 런타임 이미지에 manifest/bundle을 bake-in한 OCI 이미지를 만든다.

런타임 로딩:
- `SANTOKIT_MANIFEST_PATH=/app/santokit/manifest.json`
- `SANTOKIT_BUNDLE_PATH=/app/santokit/bundle.tgz` (또는 directory)

secrets는 배포 플랫폼이 env로 주입한다.

### 5.3 `stk deploy cfworker`
의미:
- Bridge(Workers 어댑터) + manifest/bundle을 Worker script로 빌드하고 배포한다.

타겟 식별:
- Worker 이름은 자동 생성하지 않는다.
- 사용자가 명시한다: `stk deploy cfworker --name <worker-name>`

동작:
1) build (Workers 번들)
2) 필수 secret 체크
3) 사용자 확인(prompt)
4) `wrangler deploy` 실행

---

## 6) Runtime API (Bridge)

### 6.1 `POST /call`
입력:
```json
{ "path": "users/get", "params": { "id": "..." } }
```

처리 파이프라인(최소):
1) `path`로 로직 조회(manifest)
2) private 로직 차단
3) auth 요구 사항 확인(설정에 따라 public/required)
4) params 검증(가능한 경우)
5) SQL 또는 JS 실행
6) 결과/에러 반환

에러 포맷(MVP, 초안):
```json
{ "error": { "code": "BAD_REQUEST", "message": "...", "requestId": "..." } }
```

### 6.2 Auto CRUD (Planned)
스펙은 유지한다. 구현은 Phase 5(또는 필요 시 앞당김).

- `path`: `db/{db}/{table}/{op}`
- 상세 스펙: `plan/spec/crud.md`

---

## 7) Auth / Permissions (MVP)

Hub가 없으므로, 인증은 “플랫폼/앱(외부 issuer)”에서 발급하고 Bridge가 검증한다.

MVP 정책:
- 개발/로컬: `STK_DISABLE_AUTH=true`면 모두 허용
- 배포: 외부 JWT issuer 검증(JWKS) + role claim 기반 (프로젝트별 설정)

상세 스펙:
- `plan/spec/auth.md`

권한 설정(향후):
- `config/permissions.yaml` (Auto CRUD & column prefix 규칙은 Phase 5로)

---

## 8) Type Sync (Client SDK)

`stk sync`:
- `.stk/manifest.json`을 읽어 타입 정의를 생성한다.
- 산출물: `.stk/santokit-env.d.ts`

Client SDK 호출:
- `createClient({ baseUrl, tokenStorage? })`
- `client.<namespace>.<fn>(params)` → Bridge `/call`

---

## 9) MVP Completion Criteria

1) `stk init demo`
2) `stk schema validate` 통과
3) `stk schema apply`로 Postgres에 테이블 생성
4) `logic/users/get.sql` 작성
5) `stk bundle`
6) `stk deploy image`로 로컬 실행 또는 `stk deploy cfworker`로 배포
7) `stk sync` 후 Client SDK에서 호출 성공
