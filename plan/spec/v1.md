# Santokit Rebuild Spec v1 (Slim, Auto CRUD First)

이 문서는 재창조 Santokit의 “현행 스펙(단일 진실 원천)”이다.

핵심 결정:
- Hub(Control Plane)는 필수. 웹 콘솔 없이 **CLI(`stk`)로만** 운영한다.
- 멀티 팀/프로젝트 지원(멀티테넌트). Bridge(Data Plane)는 단일 공유 런타임이 기본이다.
- v1은 **Auto CRUD**만 먼저 만든다(수동 SQL/SDK/멀티 런타임은 제외).
- BYO DB: v1은 Postgres 1개 엔진만 지원한다.
- v1의 스키마 Source of Truth는 “DB introspection snapshot”이다(선언 스키마(YAML) plan/apply는 Phase 2+).
- Data Plane 인증은 **Project API Key**로 시작한다. (End User JWT/OIDC는 Phase 2+)

---

## 1) Components

### 1.0 Hub (Control Plane)
역할:
- org/team/project/env 관리
- DB connections + secrets 저장(암호화)
- schema snapshot 저장(인트로스펙션)
- permissions / releases 저장 (Auto CRUD용)
- audit log 저장

용어:
- Operator: Hub(Control Plane)를 운영/관리하는 팀 멤버(사람)
- End User: Bridge(Data Plane)의 `/call`을 호출하는 앱의 최종 사용자(사람)

### 1.1 CLI (`stk`)
역할:
- 운영(Operator)용 단일 진입점(웹 콘솔 대체)
- Hub API를 호출해 프로젝트/환경/연결정보/권한/릴리즈/스키마 스냅샷을 조작한다

### 1.2 Bridge (Data Plane Runtime)
역할:
- `/call` API 제공
- 요청에서 `project+env` 컨텍스트를 해석
- Hub에서 현재 릴리즈(permissions + schema snapshot)를 pull/캐시 후 실행
- DB/권한/레이트리밋/감사를 강제한다

멀티 프로젝트:
- v1에서는 “한 Bridge = 여러 프로젝트/환경”이 기본이다.
- 요청은 `X-Santokit-Project`, `X-Santokit-Env` 헤더로 라우팅할 수 있다.
  - API key가 존재하면, key에 바인딩된 `project/env`가 최종 컨텍스트다(불일치 시 `403`).

지원 런타임(필수):
- Node/Docker

---

## 2) Secrets / Connections (Hub / Control Plane)

원칙:
- secret 값은 Git/manifest/bundle/image에 절대 포함하지 않는다.
- secrets/연결정보는 Hub에 저장(암호화)하고 Bridge가 런타임에 조회/캐시한다.

CLI:
- `stk connections set` (환경별 DB 연결정보 설정)
- `stk connections test` (Hub에서 DB 연결 테스트)
- `stk schema snapshot` (Hub가 DB introspection 후 schema snapshot 저장)

---

## 3) Permissions & Releases

### 3.1 Permissions
의미:
- v1은 `config/permissions.yaml` 기반 테이블 레벨 권한을 적용한다.
- 상세: `plan/spec/crud.md`

### 3.2 Release Model (Hub(Control Plane)-backed)
의미:
- Release는 “특정 `project+env`에 적용되는” 설정 번들이다:
- permissions 버전
- schema snapshot 버전(선택)
- Bridge(Data Plane)는 요청 처리 시점에 현재 릴리즈를 pull/캐시한다.

#### 3.2.1 GitOps Flow (권장)
원칙:
- “환경(dev/stg/prod)”은 **프로젝트 내부의 env**로 관리한다. env마다 프로젝트를 새로 만들지 않는다.
- Git 브랜치는 env에 매핑될 수 있다(예: `develop → dev`, `main → prod`).

Bootstrap:
1) 운영자가 한 번만 생성:
   - `stk project create <project>`
   - `stk env create --project <project> dev|stg|prod`
   - `stk connections set --project <project> --env <env> --name main --engine postgres --db-url <...>`
   - `stk schema snapshot --project <project> --env <env> --connection main` (권장)
   - `stk permissions apply --project <project> --env <env> --file config/permissions.yaml`
   - `stk release create --project <project> --env <env> --ref <gitsha>`

Deploy (CI):
- `develop` 브랜치 파이프라인:
  - `stk permissions apply --project <project> --env dev --file config/permissions.yaml`
  - `stk release create --project <project> --env dev --ref <gitsha>`
- `main` 브랜치 파이프라인:
  - `stk permissions apply --project <project> --env prod --file config/permissions.yaml`
  - `stk release create --project <project> --env prod --ref <gitsha>`

Promotion (dev → prod):
- `stk release promote --project <project> --from dev --to prod --ref <gitsha>`
  - 의미: dev의 릴리즈를 prod로 승격한다(릴리즈 포인터 이동).
  - 효과: env별 연결정보는 유지하면서, permissions/snapshot 버전을 prod에 적용한다.

Rollback (prod):
- `stk release rollback --project <project> --env prod --to <previousReleaseId>`
  - 의미: prod의 “현재 릴리즈” 포인터를 이전 릴리즈로 되돌린다.

---

## 6) Runtime API (Bridge / Data Plane)

### 6.1 `POST /call`
입력:
```json
{ "path": "db/main/users/select", "params": { "where": { "id": "..." }, "limit": 1 } }
```

인증(데이터 플레인):
- 서버/CI: `X-Santokit-Api-Key: <api_key>`
- End User: (Phase 2+) `Authorization: Bearer <jwt>`
- 상세: `plan/spec/auth.md`

컨텍스트(멀티 프로젝트/환경):
- 요청 헤더로 `project`와 `env`를 명시할 수 있다.
  - `X-Santokit-Project: <project>`
  - `X-Santokit-Env: <env>`

보안 규칙(v1, 필수):
- API key가 존재하면: key에 바인딩된 `project/env`가 최종 컨텍스트다(헤더 불일치 시 `403`).
- v1(Slim)에서는 API key가 필수다(없으면 `401`).

처리 파이프라인(최소):
1) `path`가 Auto CRUD인지 확인: `db/{db}/{table}/{op}`
2) API key 검증 + `project/env` 컨텍스트 확정
3) 현재 릴리즈 로드(permissions + schema snapshot)
4) permissions 체크
5) params 검증
6) SQL 생성 + 실행
7) 결과/에러 반환

에러 포맷(MVP, 초안):
```json
{ "error": { "code": "BAD_REQUEST", "message": "...", "requestId": "..." } }
```

### 6.2 Auto CRUD
v1 핵심 기능이다.

- `path`: `db/{db}/{table}/{op}`
- 상세 스펙: `plan/spec/crud.md`

---

## 7) MVP Completion Criteria

1) Operator가 `project/env` 생성
2) DB connection 등록 + `stk permissions apply` 성공
3) `stk release create` 성공
4) Bridge(Data Plane)에서 `db/main/<table>/select` 호출 성공
5) role 불일치/환경 불일치가 `403`으로 차단됨
