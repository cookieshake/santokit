---
id: SDK-003
domain: sdk
title: Generated CRUD API shape
status: planned
depends: [SDK-001]
spec_refs: []
test_refs: []
code_refs: []
---

## Intent

생성된 SDK가 Bridge `/call`의 params 구조를 그대로 타입으로 제공하여, 개발자가 체이닝 없이 직관적인 메서드 호출로 CRUD 작업을 수행할 수 있도록 한다. 컴파일 타임에 잘못된 테이블 접근을 방지하고, 런타임에는 Bridge로의 `POST /call` 요청으로 변환된다.

## Execution Semantics

- 코드 생성 단계에서 스키마 IR의 각 테이블마다 테이블 클래스를 생성한다.
- 각 테이블 클래스는 `select`, `insert`, `update`, `delete` 메서드를 갖는다.
- 메서드 파라미터 타입은 `plan/spec/crud.md`의 `/call` params 구조와 일치한다.
- 클라이언트 진입점(`MyAppClient` 등)의 `db` 프로퍼티는 테이블 이름을 키로 하는 객체를 노출하며, 값은 해당 테이블 클래스 인스턴스다.
- 테이블 이름은 camelCase로 변환된다. 충돌 시 원본 문자열 키 접근도 함께 제공한다.
- 런타임에 각 메서드는 Bridge `POST /call`에 적절한 path와 params를 담아 요청한다.

### 메서드 시그니처

```typescript
// select: where / orderBy / limit / offset / expand 파라미터 지원
async select(params?: {
  where?: Partial<RowType>;
  orderBy?: Record<string, 'asc' | 'desc'>;
  limit?: number;
  offset?: number;
  expand?: string[];
}): Promise<RowType[]>

// insert: 단건 또는 복수 행 삽입, 삽입된 행 반환
async insert(data: InsertType | InsertType[]): Promise<RowType[]>

// update: where 조건에 매칭되는 행의 일부 컬럼 갱신, 갱신된 행 반환
async update(where: Partial<RowType>, data: Partial<InsertType>): Promise<RowType[]>

// delete: where 조건에 매칭되는 행 삭제, 영향받은 행 수 반환
async delete(where: Partial<RowType>): Promise<{ affected: number }>
```

## Observable Outcome

- 생성된 파일에 각 테이블에 대한 `select`, `insert`, `update`, `delete` 메서드가 포함된다.
- `client.db.<table>` 형태로 테이블에 접근할 수 있다.
- 메서드 파라미터와 반환 타입이 스키마 IR에서 파생된 타입으로 정적으로 지정된다.

## Usage

```typescript
// 생성된 SDK 사용 예시
import { MyAppClient } from './generated/client';

const client = new MyAppClient({
  bridgeUrl: 'https://bridge.example.com',
  apiKey: 'stk_key_...',
});

// select
const users = await client.db.users.select({
  where: { email: 'alice@example.com' },
  orderBy: { created_at: 'desc' },
  limit: 20,
  offset: 0,
  expand: ['profile'],
});

// insert
const created = await client.db.users.insert({
  email: 'bob@example.com',
  name: 'Bob',
});

// update
const updated = await client.db.users.update(
  { id: '123' },
  { name: 'Bobby' },
);

// delete
const result = await client.db.users.delete({ id: '123' });
console.log(result.affected); // 1
```

생성된 TypeScript 코드 구조 예시:

```typescript
// generated by stk gen client (v0)
// releaseId: rel_abc123
// generatedBy: stk/0.1.0

export interface User {
  id: string;
  email: string;
  name: string;
  created_at: string;
}

export interface InsertUser {
  email: string;
  name: string;
}

export class UsersTable {
  constructor(private client: SantokitClient) {}

  async select(params?: {
    where?: Partial<User>;
    orderBy?: Record<string, 'asc' | 'desc'>;
    limit?: number;
    offset?: number;
    expand?: string[];
  }): Promise<User[]> { /* POST /call */ }

  async insert(data: InsertUser | InsertUser[]): Promise<User[]> { /* POST /call */ }
  async update(where: Partial<User>, data: Partial<InsertUser>): Promise<User[]> { /* POST /call */ }
  async delete(where: Partial<User>): Promise<{ affected: number }> { /* POST /call */ }
}

export class MyAppClient {
  db: {
    users: UsersTable;
  };

  constructor(config: { bridgeUrl: string; apiKey?: string; accessToken?: string }) {
    /* ... */
  }
}
```

## Acceptance Criteria

- [ ] 생성된 클라이언트의 `select` 메서드가 `where`, `orderBy`, `limit`, `offset`, `expand` 파라미터를 허용한다.
- [ ] `insert` 메서드가 단건 및 복수 행 데이터를 허용한다.
- [ ] `update` 메서드가 `where`와 `data`를 분리된 파라미터로 받는다.
- [ ] `delete` 메서드가 `where`를 받고 `{ affected: number }`를 반환한다.
- [ ] 스키마에 없는 테이블에 접근하면 TypeScript 컴파일 타임 오류가 발생한다.

## Failure Modes

- 스키마에 없는 테이블에 접근: `client.db`의 타입에 해당 키가 없으므로 TypeScript 컴파일 오류(컴파일 타임 실패).
- Bridge로부터 HTTP 403 반환: Bridge가 권한 부족으로 거부한 경우. SDK는 `SantokitError`를 throw한다(SDK-004 참조).
- Bridge로부터 HTTP 400 반환: 잘못된 params 구조 등 요청 오류. SDK는 `SantokitError`를 throw한다.
