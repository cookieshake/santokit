# Prometheus Alerting Rules for Santokit

groups:
  - name: bridge_performance
    interval: 30s
    rules:
      - alert: BridgeHighLatency
        expr: histogram_quantile(0.95, rate(stk_bridge_request_duration_seconds_bucket[5m])) > 0.5
        for: 5m
        labels:
          severity: warning
          component: bridge
        annotations:
          summary: "Bridge p95 latency > 500ms"
          description: "Bridge {{ $labels.instance }} p95 latency is {{ $value }}s (threshold: 0.5s)"
          runbook: "https://docs.santokit.com/runbooks/high-latency"

      - alert: BridgeHighErrorRate
        expr: (rate(stk_bridge_errors_total[5m]) / rate(stk_bridge_requests_total[5m])) > 0.01
        for: 2m
        labels:
          severity: critical
          component: bridge
        annotations:
          summary: "Bridge error rate > 1%"
          description: "Bridge {{ $labels.instance }} error rate is {{ $value | humanizePercentage }}"
          runbook: "https://docs.santokit.com/runbooks/high-error-rate"

      - alert: BridgeDown
        expr: up{job="santokit-bridge"} == 0
        for: 1m
        labels:
          severity: critical
          component: bridge
        annotations:
          summary: "Bridge instance down"
          description: "Bridge {{ $labels.instance }} is down"
          runbook: "https://docs.santokit.com/runbooks/bridge-down"

  - name: bridge_capacity
    interval: 30s
    rules:
      - alert: BridgeDBPoolSaturation
        expr: (stk_bridge_db_pool_active / stk_bridge_db_pool_max) > 0.9
        for: 5m
        labels:
          severity: warning
          component: bridge
        annotations:
          summary: "DB connection pool > 90% saturated"
          description: "Bridge {{ $labels.instance }} DB pool usage: {{ $value | humanizePercentage }}"
          runbook: "https://docs.santokit.com/runbooks/db-pool-saturation"

      - alert: BridgeStaleCacheDetected
        expr: stk_bridge_release_cache_age_seconds > 600
        for: 2m
        labels:
          severity: warning
          component: bridge
        annotations:
          summary: "Bridge release cache stale > 10 minutes"
          description: "Bridge {{ $labels.instance }} cache age: {{ $value }}s"
          runbook: "https://docs.santokit.com/runbooks/stale-cache"

      - alert: BridgeHighCPU
        expr: rate(process_cpu_seconds_total{job="santokit-bridge"}[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: bridge
        annotations:
          summary: "Bridge CPU usage > 80%"
          description: "Bridge {{ $labels.instance }} CPU: {{ $value | humanizePercentage }}"
          runbook: "https://docs.santokit.com/runbooks/high-cpu"

      - alert: BridgeHighMemory
        expr: (process_resident_memory_bytes{job="santokit-bridge"} / 1024 / 1024 / 1024) > 3.5
        for: 5m
        labels:
          severity: warning
          component: bridge
        annotations:
          summary: "Bridge memory usage > 3.5GB"
          description: "Bridge {{ $labels.instance }} memory: {{ $value }}GB"
          runbook: "https://docs.santokit.com/runbooks/high-memory"

  - name: hub_operations
    interval: 30s
    rules:
      - alert: HubDown
        expr: up{job="santokit-hub"} == 0
        for: 1m
        labels:
          severity: critical
          component: hub
        annotations:
          summary: "Hub instance down"
          description: "Hub {{ $labels.instance }} is down"
          runbook: "https://docs.santokit.com/runbooks/hub-down"

      - alert: HubSlowSchemaApply
        expr: histogram_quantile(0.95, rate(stk_hub_schema_apply_duration_seconds_bucket[5m])) > 10
        for: 5m
        labels:
          severity: warning
          component: hub
        annotations:
          summary: "Hub schema apply p95 > 10s"
          description: "Hub {{ $labels.instance }} schema apply duration: {{ $value }}s"
          runbook: "https://docs.santokit.com/runbooks/slow-schema-apply"

      - alert: HubSchemaApplyFailures
        expr: rate(stk_hub_schema_applies_total{result="failure"}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: hub
        annotations:
          summary: "Hub schema apply failures detected"
          description: "Hub {{ $labels.instance }} schema apply failure rate: {{ $value }}/s"
          runbook: "https://docs.santokit.com/runbooks/schema-apply-failures"

  - name: database
    interval: 30s
    rules:
      - alert: SlowDatabaseQueries
        expr: histogram_quantile(0.95, rate(stk_bridge_db_query_duration_seconds_bucket[5m])) > 0.1
        for: 10m
        labels:
          severity: warning
          component: database
        annotations:
          summary: "Database query p95 > 100ms"
          description: "Bridge {{ $labels.instance }} DB query p95: {{ $value }}s"
          runbook: "https://docs.santokit.com/runbooks/slow-queries"

      - alert: DatabaseConnectionFailures
        expr: rate(stk_bridge_db_connection_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Database connection failures detected"
          description: "Bridge {{ $labels.instance }} DB connection errors: {{ $value }}/s"
          runbook: "https://docs.santokit.com/runbooks/db-connection-failures"

  - name: events
    interval: 30s
    rules:
      - alert: EventDLQGrowing
        expr: stk_events_dlq_size > 1000
        for: 5m
        labels:
          severity: warning
          component: events
        annotations:
          summary: "Event DLQ size > 1000"
          description: "Topic {{ $labels.topic }} DLQ size: {{ $value }}"
          runbook: "https://docs.santokit.com/runbooks/dlq-growing"

      - alert: EventHandlerFailures
        expr: rate(stk_events_handler_failures_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          component: events
        annotations:
          summary: "Event handler failures > 1/s"
          description: "Handler {{ $labels.handler }} failure rate: {{ $value }}/s"
          runbook: "https://docs.santokit.com/runbooks/handler-failures"

  - name: security
    interval: 30s
    rules:
      - alert: HighAuthenticationFailures
        expr: rate(stk_bridge_auth_failures_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "High authentication failure rate"
          description: "Bridge {{ $labels.instance }} auth failures: {{ $value }}/s (possible brute-force attack)"
          runbook: "https://docs.santokit.com/runbooks/auth-failures"

      - alert: HighPermissionDenials
        expr: rate(stk_bridge_permission_denials_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          component: security
        annotations:
          summary: "High permission denial rate"
          description: "Bridge {{ $labels.instance }} permission denials: {{ $value }}/s (possible misconfiguration)"
          runbook: "https://docs.santokit.com/runbooks/permission-denials"

  - name: capacity
    interval: 60s
    rules:
      - alert: HighTableCount
        expr: stk_hub_tables_per_connection > 400
        for: 10m
        labels:
          severity: info
          component: capacity
        annotations:
          summary: "High table count approaching limit"
          description: "Connection {{ $labels.connection }} has {{ $value }} tables (limit: 500)"
          runbook: "https://docs.santokit.com/runbooks/high-table-count"

      - alert: AuditLogGrowthHigh
        expr: rate(stk_hub_audit_log_entries_total[1h]) > 1000000
        for: 1h
        labels:
          severity: info
          component: capacity
        annotations:
          summary: "Audit log growth > 1M entries/hour"
          description: "Audit log growth rate: {{ $value }}/hour"
          runbook: "https://docs.santokit.com/runbooks/audit-log-growth"
