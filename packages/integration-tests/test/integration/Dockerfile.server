FROM node:20-bookworm
WORKDIR /app

# Install TSX to run TypeScript directly
RUN npm install -g tsx typescript

# Install dependencies for the runner script
RUN npm install redis pg @types/pg

# Copy packages
COPY packages/server /app/packages/server
COPY packages/client /app/packages/client

# Inject the Test Server Runner Script
COPY packages/integration-tests/test/integration/runner-server.ts /app/runner-server.ts

ENV STK_ENCRYPTION_KEY=32-byte-key-for-aes-256-gcm!!!!!
EXPOSE 3000
CMD ["tsx", "/app/runner-server.ts"]
