# 04. Hub & Vault 명세

## 역할
"제어 플레인(Control Plane)". 상태, 보안, 배포를 관리합니다. 프로덕션 트래픽에 대한 사용자 로직을 실행하지 **않습니다**.

## 아키텍처
*   **언어**: Go.
*   **데이터베이스**: 사용자 계정, 프로젝트, 버전 기록을 위한 시스템 DB (PostgreSQL).

## 3가지 핵심 엔진

### 1. 매니페스트 레지스트리
*   모든 프로젝트 버전의 "진실의 원천(Source of Truth)"을 저장합니다.
*   **로직 버전 관리**: 로직 배포의 불변 스냅샷을 저장합니다.
*   **스키마 기록**: Atlas 클라우드 또는 내부 추적을 통해 적용된 마이그레이션을 추적합니다.

### 2. Santokit-Vault (보안)
*   **책임**: 평문 비밀 정보가 존재하는 유일한 곳입니다 (저장 시 암호화됨).
*   **암호화**: AES-256-GCM.
*   **입력**: `stk secret set`을 통해 입력.
*   **출력 (프로비저닝)**:
    *   Server(Edge)로 푸시할 때, 비밀 정보는 Hub와 Server만 아는 공유 마스터 키로 재암호화됩니다.
    *   비밀 정보는 "프로비저닝 패키지"에 포함됩니다.

### 3. 스키마 실행기 (Atlas 통합)
*   `base/*.hcl` 내용을 수신합니다 (`stk schema`).
*   (Atlas를 사용하여) 현재 DB 상태와의 차이를 계산합니다.
*   SQL 마이그레이션 계획을 생성합니다.
*   사용자 승인 시 마이그레이션을 실행합니다.

## 프로비저닝 메커니즘 ("Push" 전략)
Edge가 매번 Hub에 묻지 않고 수행할 작업을 아는 방법입니다.

1.  **이벤트**: 사용자가 `stk logic apply`를 실행합니다.
2.  **빌드**: Hub가 로직 + (복호화 후 재암호화된) 비밀 정보 + 설정을 검증하고 번들링합니다.
3.  **배포**:
    *   Hub가 이 번들을 **Cloudflare KV (Edge Storage)**로 푸시합니다.
    *   키: `project:{id}:latest`.
    *   값: 모든 로직과 메타데이터를 포함한 압축된 JSON/Binary.
4.  **결과**: 전 세계의 Edge 노드에서 최신 정의를 즉시 사용할 수 있게 됩니다.

## 콘솔 (웹 UI)
MVP에서는 콘솔을 제공하지 않으며, 모든 관리는 CLI로 수행합니다.
동기화(Sync)는 `stk sync`로만 수행합니다.
