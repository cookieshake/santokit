version: "3.9"

services:
  redis:
    image: redis:7-alpine
    container_name: santokit-it-redis
    networks:
      santokit-it:
        aliases: [redis]

  postgres:
    image: postgres:15-alpine
    container_name: santokit-it-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: santokit
    networks:
      santokit-it:
        aliases: [postgres]

  hub:
    build:
      context: .
      dockerfile: packages/integration-tests/test/integration/Dockerfile.hub
    image: santokit-hub-test:latest
    container_name: santokit-it-hub
    environment:
      STK_HUB_ADDR: ":8080"
      STK_DISABLE_AUTH: "true"
      STK_KV_REDIS: "redis://redis:6379"
      STK_DATABASE_URL: "postgres://postgres:password@postgres:5432/santokit?sslmode=disable"
      STK_ENCRYPTION_KEY: "32-byte-key-for-aes-256-gcm!!!!!"
    depends_on:
      - redis
      - postgres
    ports:
      - "55880:8080"
    networks:
      santokit-it:
        aliases: [hub]

  bridge:
    build:
      context: .
      dockerfile: packages/integration-tests/test/integration/Dockerfile.server
    image: santokit-server-test:latest
    container_name: santokit-it-bridge
    environment:
      REDIS_URL: "redis://redis:6379"
      DATABASE_URL: "postgres://postgres:password@postgres:5432/santokit?sslmode=disable"
      STK_ENCRYPTION_KEY: "32-byte-key-for-aes-256-gcm!!!!!"
      STORAGE_ENDPOINT: "http://user:80"
      STORAGE_ACCESS_KEY_ID: "test-access"
      STORAGE_SECRET_ACCESS_KEY: "test-secret"
      STORAGE_REGION: "auto"
    depends_on:
      - redis
      - postgres
      - hub
      - user
    ports:
      - "55830:3000"
    networks:
      santokit-it:
        aliases: [bridge]

  cli:
    build:
      context: .
      dockerfile: packages/integration-tests/test/integration/Dockerfile.cli
    image: santokit-cli-test:latest
    container_name: santokit-it-cli
    environment:
      HOME: /data/home
      STK_HUB_URL: "http://hub:8080"
      STK_PROJECT_ID: "default"
      STK_TOKEN: "test-token"
      STK_DISABLE_AUTH: "true"
    volumes:
      - .:/workspace
      - santokit-cli-home:/data/home
    networks:
      santokit-it:
        aliases: [cli]

  client:
    build:
      context: .
      dockerfile: packages/integration-tests/test/integration/Dockerfile.node
    image: santokit-node-test:latest
    container_name: santokit-it-client
    volumes:
      - .:/workspace
    networks:
      santokit-it:
        aliases: [client]

  user:
    image: nginx:1.27-alpine
    container_name: santokit-it-user
    networks:
      santokit-it:
        aliases: [user]

networks:
  santokit-it:
    name: santokit-it

volumes:
  santokit-cli-home:
